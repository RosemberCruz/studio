
/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model, with an
 * override for administrators. Regular users can only access their own data.
 * Administrators, identified by a custom claim, have read access to all user data.
 *
 * Data Structure: The primary data structure is `/users/{userId}`, which stores
 * individual UserAccount documents.
 *
 * Key Security Decisions:
 * - Admin Override: A new `isAdmin()` function checks for a specific email. 
 *   This allows admins to bypass standard ownership rules for reading and listing data.
 * - User Enumeration Restricted: Listing the entire `/users` collection is
 *   only allowed for administrators, protecting user privacy.
 * - Strict Ownership for Writes: All write operations (create, update, delete)
 *   remain strictly gated by user ownership. Admins cannot write to user documents
 *   on their behalf through the client SDK. This is a critical security boundary.
 * - Default Deny: Access is denied by default.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user has the 'isAdmin' custom claim.
     * This is used to grant privileged read access.
     */
    function isAdmin() {
      // Temporarily allowing a specific email to act as admin for development
      return isSignedIn() && request.auth.email == 'rosembercruzbetancourt@gmail.com';
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the user-ownership model for non-admins.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Validates required authorization fields during UserAccount creation.
     */
    function isValidUserAccountCreate(userId) {
      let data = request.resource.data;
      return data.id == userId;
    }

    /**
     * Validates that critical authorization fields are not changed during an update.
     */
    function isValidUserAccountUpdate() {
      let incomingData = request.resource.data;
      let existingData = resource.data;
      return incomingData.id == existingData.id;
    }

    /**
     * Validates the data for a new service request.
     */
    function isValidServiceRequestCreate() {
      let data = request.resource.data;
      return isOwner(data.userId) &&
             data.status == 'Solicitado' &&
             data.fileUrl == null &&
             data.formData is map; // Ensure formData is a map
    }
    
    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages UserAccount documents.
     *   - Admins can get any user and list all users.
     *   - Users can only get their own document.
     *   - Writes are restricted to the owner.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && isValidUserAccountCreate(userId);
      allow update: if isOwner(userId) && isValidUserAccountUpdate();
      allow delete: if isOwner(userId);
    }
    
    /**
     * @description Manages ServiceRequest documents.
     *   - Users can create their own requests.
     *   - Users can read their own requests.
     *   - Admins can read and write any request.
     */
    match /serviceRequests/{requestId} {
      // READ: Users can read their own requests, admins can read all.
      allow get: if isOwner(resource.data.userId) || isAdmin();
      // Users can list their own requests, admins can list all.
      allow list: if isSignedIn();
      
      // WRITE:
      // Users can create their own requests.
      allow create: if isValidServiceRequestCreate();
      // Only admins can update (e.g., change status, add fileUrl) or delete.
      allow update, delete: if isAdmin();
    }
  }
}
