
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the user-ownership model for non-admins.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Validates required authorization fields during UserAccount creation.
     * Ensures that a user can only create their own document.
     */
    function isValidUserAccountCreate(userId) {
      let data = request.resource.data;
      // The user creating the document must be the owner (isOwner check is also applied).
      // The `id` field in the document must match the creator's UID.
      return isOwner(userId) &&
             data.id == userId &&
             data.balance == 0 &&
             data.credits == 0 &&
             data.promotionalCredits == 0 &&
             data.promoCreditsGrantDate == null; // Ensure initial expiration is null
    }


    /**
     * Validates that critical authorization fields are not changed during an update.
     */
    function isValidUserAccountUpdate() {
      let incomingData = request.resource.data;
      let existingData = resource.data;
      let isAdminCheck = request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2';
      // Users cannot change their own ID.
      // Only an admin can change a user's balance/credits. Regular users cannot.
      return incomingData.id == existingData.id &&
             (incomingData.balance == existingData.balance || isAdminCheck) &&
             (incomingData.credits == existingData.credits || isAdminCheck) &&
             (incomingData.promotionalCredits == existingData.promotionalCredits || isAdminCheck) &&
             (incomingData.promoCreditsGrantDate == existingData.promoCreditsGrantDate || isAdminCheck); // Admin can change grant date
    }

    /**
     * Validates the data for a new service request.
     */
    function isValidServiceRequestCreate() {
      let data = request.resource.data;
      return isOwner(data.userId) &&
             data.status == 'Solicitado' &&
             data.fileUrl == null &&
             data.formData is map; // Ensure formData is a map
    }

    /**
     * Validates data for a new deposit request.
     */
    function isValidDepositRequestCreate() {
      let data = request.resource.data;
      return isOwner(data.userId) &&
             data.status == 'pendiente' &&
             data.amount > 0 &&
             data.trackingKey is string;
    }
    
    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages UserAccount documents.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || (request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2');
      allow create: if isValidUserAccountCreate(userId);
      allow update: if (isOwner(userId) && isValidUserAccountUpdate()) || (request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2');
      allow delete: if request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2';
      allow list: if request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2';
    }
    
    /**
     * @description Manages service requests.
     */
    match /serviceRequests {
      // Rules for the entire collection
      allow list: if request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2';
      allow create: if isValidServiceRequestCreate();

      // Rules for individual documents within the collection
      match /{requestId} {
        allow get: if (request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2') || isOwner(resource.data.userId);
        allow update, delete: if request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2';
      }
    }

    /**
     * @description Manages user-submitted deposit requests for balance recharges.
     */
    match /depositRequests/{requestId} {
      // READ: Only admins can read the list of deposit requests. Users can read their own.
      allow get: if (request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2') || isOwner(resource.data.userId);
      allow list: if request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2';
      // WRITE: Users can create their own valid requests. Admins can update/delete any.
      allow create: if isValidDepositRequestCreate();
      allow update, delete: if request.auth != null && request.auth.uid == 'LMXNKsZh9NMgk3tKoyyqYlqcbFY2';
    }
  }
}
